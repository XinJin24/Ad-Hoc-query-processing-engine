
import os
import psycopg2
import psycopg2.extras
import tabulate
from prettytable import PrettyTable
from _H_class_generated import H
import collections
from dotenv import load_dotenv

# DO NOT EDIT THIS FILE, IT IS GENERATED BY generator.py

def query():
    load_dotenv()

    user = os.getenv('USER')
    password = os.getenv('PASSWORD')
    dbname = os.getenv('DBNAME')

    conn = psycopg2.connect("dbname="+dbname+" user="+user+" password="+password,
                            cursor_factory=psycopg2.extras.DictCursor)

    cur = conn.cursor()
    cur.execute("SELECT * FROM sales")
    rows = cur.fetchall()
    
    mf_structure = collections.defaultdict(H)
    for row in rows:
        group_cust = row[0]
        group_prod = row[1]
        if row[4] == 2017:
            if not (mf_structure[(group_cust, group_prod)]['cust'] and mf_structure[(group_cust, group_prod)]['prod']):
                mf_structure[(group_cust, group_prod)]['cust'] = group_cust
                mf_structure[(group_cust, group_prod)]['prod'] = group_prod
            if '1_max_quant' not in mf_structure[(group_cust, group_prod)] or row[6] > mf_structure[(group_cust, group_prod)]['1_max_quant']:
                mf_structure[(group_cust, group_prod)]['1_max_quant'] = row[6]
            mf_structure[(group_cust, group_prod)]['1.state'] = row[5]
        if row[4] == 2018:
            if not (mf_structure[(group_cust, group_prod)]['cust'] and mf_structure[(group_cust, group_prod)]['prod']):
                mf_structure[(group_cust, group_prod)]['cust'] = group_cust
                mf_structure[(group_cust, group_prod)]['prod'] = group_prod
            if '2_max_quant' not in mf_structure[(group_cust, group_prod)] or row[6] > mf_structure[(group_cust, group_prod)]['2_max_quant']:
                mf_structure[(group_cust, group_prod)]['2_max_quant'] = row[6]
            mf_structure[(group_cust, group_prod)]['2.state'] = row[5]
        if row[4] == 2019:
            if not (mf_structure[(group_cust, group_prod)]['cust'] and mf_structure[(group_cust, group_prod)]['prod']):
                mf_structure[(group_cust, group_prod)]['cust'] = group_cust
                mf_structure[(group_cust, group_prod)]['prod'] = group_prod
            if '3_max_quant' not in mf_structure[(group_cust, group_prod)] or row[6] > mf_structure[(group_cust, group_prod)]['3_max_quant']:
                mf_structure[(group_cust, group_prod)]['3_max_quant'] = row[6]
            mf_structure[(group_cust, group_prod)]['3.state'] = row[5]
    # second scan
    mf_structure_0 = collections.defaultdict(H)
    for row in rows:
        group_cust = row[0]
        group_prod = row[1]
        if row[6] == mf_structure[((group_cust, group_prod))]['1_max_quant']:
            if not (mf_structure_0[(group_cust, group_prod)]['cust'] and mf_structure_0[(group_cust, group_prod)]['prod']):
                mf_structure_0[(group_cust, group_prod)]['cust'] = group_cust
                mf_structure_0[(group_cust, group_prod)]['prod'] = group_prod
            if '1_max_quant' not in mf_structure_0[(group_cust, group_prod)] or row[6] > mf_structure_0[(group_cust, group_prod)]['1_max_quant']:
                mf_structure_0[(group_cust, group_prod)]['1_max_quant'] = row[6]
            mf_structure_0[(group_cust, group_prod)]['1.state'] = row[5]
    for row in rows:
        group_cust = row[0]
        group_prod = row[1]
        if row[6] == mf_structure[((group_cust, group_prod))]['2_max_quant']:
            if not (mf_structure_0[(group_cust, group_prod)]['cust'] and mf_structure_0[(group_cust, group_prod)]['prod']):
                mf_structure_0[(group_cust, group_prod)]['cust'] = group_cust
                mf_structure_0[(group_cust, group_prod)]['prod'] = group_prod
            if '2_max_quant' not in mf_structure_0[(group_cust, group_prod)] or row[6] > mf_structure_0[(group_cust, group_prod)]['2_max_quant']:
                mf_structure_0[(group_cust, group_prod)]['2_max_quant'] = row[6]
            mf_structure_0[(group_cust, group_prod)]['2.state'] = row[5]
    for row in rows:
        group_cust = row[0]
        group_prod = row[1]
        if row[6] == mf_structure[((group_cust, group_prod))]['3_max_quant']:
            if not (mf_structure_0[(group_cust, group_prod)]['cust'] and mf_structure_0[(group_cust, group_prod)]['prod']):
                mf_structure_0[(group_cust, group_prod)]['cust'] = group_cust
                mf_structure_0[(group_cust, group_prod)]['prod'] = group_prod
            if '3_max_quant' not in mf_structure_0[(group_cust, group_prod)] or row[6] > mf_structure_0[(group_cust, group_prod)]['3_max_quant']:
                mf_structure_0[(group_cust, group_prod)]['3_max_quant'] = row[6]
            mf_structure_0[(group_cust, group_prod)]['3.state'] = row[5]
    

    for key, updated_h_object in mf_structure_0.items():
        if key in mf_structure:
            original_h_object = mf_structure[key]
            for attr, value in updated_h_object.attributes.items():
                if value != 0:
                    original_h_object.attributes[attr] = value
        else:
            mf_structure[key] = updated_h_object
        
    x = PrettyTable()
    x.field_names = ['cust','prod','1_max_quant','1.state','2_max_quant','2.state','3_max_quant','3.state']
    for val in mf_structure.values():
            row = [val[key] for key in x.field_names if key in val]
            x.add_row(row)
    print(x)


    _global = []
    return tabulate.tabulate(_global,
                        headers="keys", tablefmt="psql")

def main():
    print(query())

if "__main__" == __name__:
    main()
    